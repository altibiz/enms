@namespace Enms.Client.Shared.Layout
@using System.Globalization
@using Enms.Business.Queries.Agnostic
@using Enms.Business.Models.Base
@using Enms.Client.State
@using Enms.Client.Shared.Streaming
@using Microsoft.AspNetCore.Antiforgery
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Http
@using Microsoft.Extensions.DependencyInjection
@using MudBlazor
@inherits Enms.Client.Base.EnmsOwningLayoutComponentBase
@inject IAntiforgery Antiforgery
@inject IHttpContextAccessor HttpContextAccessor

<MudLayout>
  <MudAppBar Elevation="0" Color="Color.Tertiary" Gutters="false">
    <MudContainer MaxWidth="MaxWidth.Large" Class="d-flex flex-row">
      <MudButton
        Href="@($"/app/{Culture}")"
        Style="margin-left: -8px;"
        Class="d-flex align-center">
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
          <MudImage
            Src="/logo.svg"
            Alt="HelbEx"
            Style="height: calc(var(--mud-appbar-height) * 0.6);" />
        </MudHidden>
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
          <MudImage
            Src="/favicon.svg"
            Alt="HelbEx"
            Style="height: calc(var(--mud-appbar-height) * 0.6);" />
        </MudHidden>
      </MudButton>
      <MudSpacer />
      <div Class="d-flex flex-row justify-end">
        <MudButton
          Variant="Variant.Text"
          Color="Color.Primary"
          OnClick="e => _localizationDrawerOpen = !_localizationDrawerOpen"
          Class="d-flex flex-row align-center">
          <MudIcon Icon="@Icons.Material.Filled.Language" />
          <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <div Class="ml-2">
              <MudText>@Culture</MudText>
            </div>
          </MudHidden>
        </MudButton>
        <MudButton
          OnClick="e => _userDrawerOpen = !_userDrawerOpen"
          Variant="Variant.Text"
          Color="Color.Primary"
          Class="d-flex flex-row align-center"
          Style="margin-right: -8px;">
          <MudIcon Icon="@Icons.Material.Filled.Person"/>
          <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <div Class="ml-2 d-flex flex-column align-center">
              <MudText>
                @Translate("Welcome,")
              </MudText>
              <MudText>
                @UserState.User.UserName
              </MudText>
            </div>
          </MudHidden>
        </MudButton>
      </div>
    </MudContainer>
  </MudAppBar>
  <MudDrawer
    @bind-Open="_userDrawerOpen"
    Elevation="0"
    Anchor="Anchor.Bottom"
    Variant="DrawerVariant.Temporary"
    ClipMode="DrawerClipMode.Never">
    <MudDrawerContainer>
      <MudList T="string">
        <MudListItem
          Text="@Translate("Account")"
          OnClick="e => _userDrawerOpen = false"
          Icon="@Icons.Material.Outlined.Person"
          Href="account" />
        <MudListItem
          Text="@Translate("Logout")"
          OnClick="e => _userDrawerOpen = false"
          Icon="@Icons.Material.Outlined.Login">
          <MudForm method="post" action="/Users/LogOff?returnUrl=/login">
            <AntiforgeryToken />
            <MudButton
              ButtonType="ButtonType.Submit"
              Style="justify-content: start; padding: 0;">
              @Translate("Logout")
            </MudButton>
          </MudForm>
        </MudListItem>
      </MudList>
    </MudDrawerContainer>
  </MudDrawer>
  <MudDrawer
    @bind-Open="_localizationDrawerOpen"
    Elevation="0"
    Anchor="Anchor.Bottom"
    Variant="DrawerVariant.Temporary"
    ClipMode="DrawerClipMode.Never">
    <MudDrawerHeader>
      <MudText Typo="Typo.h6" Style="text-align: center;">
        @Translate("Localization")
      </MudText>
    </MudDrawerHeader>
    <MudDivider />
    <MudDrawerContainer>
      <MudList T="string">
        <MudListItem
          Text="@(new CultureInfo("hr").NativeName)"
          Icon="@Icons.Material.Filled.Language"
          OnClick="@(e => {
            Culture = new CultureInfo("hr");
            _localizationDrawerOpen = false;
          })" />
        <MudListItem
          Text="@(new CultureInfo("en").NativeName)"
          Icon="@Icons.Material.Filled.Language"
          OnClick="@(e => {
            Culture = new CultureInfo("en");
            _localizationDrawerOpen = false;
          })" />
      </MudList>
    </MudDrawerContainer>
  </MudDrawer>
  <MudMainContent>
    @Body
  </MudMainContent>
</MudLayout>

@code {

  [CascadingParameter]
  public UserState UserState { get; set; } = default!;

  private bool _userDrawerOpen { get; set; } = default!;

  private bool _localizationDrawerOpen { get; set; } = default!;
}
