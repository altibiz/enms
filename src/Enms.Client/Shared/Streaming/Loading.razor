@namespace Enms.Client.Shared.Streaming

@attribute [StreamRendering]

@typeparam T
@using System.Text.Json
@using Enms.Business.Models.Abstractions
@using Enms.Business.Queries.Agnostic
@using Enms.Client.State
@using Microsoft.Extensions.DependencyInjection
@using MudBlazor
@inherits Enms.Client.Base.EnmsOwningComponentBase

@if (_state.State is LoadingState.Loading)
{
  if (Progress is not null)
  {
    @Progress
    return;
  }

  <MudProgressCircular/>
  return;
}

@if (_state.State is LoadingState.Error)
{
  if (Error is not null)
  {
    @Error(_state.Error!)
    return;
  }

  <MudAlert Severity="Severity.Error">
    @_state.Error
  </MudAlert>
  return;
}

@if (_state.State is LoadingState.Unfound)
{
  if (NotFound is not null)
  {
    @NotFound
    return;
  }

  <NotFound/>
  return;
}

@if (_state.State is LoadingState.Created)
{
  if (Created is not null)
  {
    @Created(_state.Value!)
    return;
  }

  return;
}

@if (Found is not null)
{
  @Found(_state.Value!)
  return;
}

<MudText>
  @JsonSerializer.Serialize(_state.Value!, JsonSerializerOptions)
</MudText>

@code {

  [Parameter]
  public T? Value { get; set; }

  [Parameter]
  public RenderFragment? Progress { get; set; }

  [Parameter]
  public RenderFragment<string>? Error { get; set; }

  [Parameter]
  public string? Id { get; set; }

  [Parameter]
  public Func<T?>? Load { get; set; }

  [Parameter]
  public Func<Task<T?>>? LoadAsync { get; set; }

  [Parameter]
  public Func<T>? New { get; set; }

  [Parameter]
  public Func<Task<T>>? NewAsync { get; set; }

  [Parameter]
  public bool Activate { get; set; }

  [Parameter]
  public bool ActivateAsync { get; set; }

  [Parameter]
  public RenderFragment? NotFound { get; set; }

  [Parameter]
  public RenderFragment<T>? Found { get; set; }

  [Parameter]
  public RenderFragment<T>? Created { get; set; }

  private LoadingState<T> _state = new();

  private static readonly JsonSerializerOptions JsonSerializerOptions =
    new()
    {
      WriteIndented = true
    };

  protected override void OnParametersSet()
  {
    if (Value is not null)
    {
      _state = _state.WithValue(Value);
    }
  }

  protected override void OnInitialized()
  {
    if (_state.State is not LoadingState.Loading or LoadingState.Unfound)
    {
      return;
    }

    if (Load is not null)
    {
      try
      {
        _state = _state.WithValue(Load());
      }
      catch (Exception e)
      {
        _state = _state.WithError(e.Message);
      }
    }

    if (_state.State is not LoadingState.Loading or LoadingState.Unfound)
    {
      return;
    }

    if (New is not null)
    {
      try
      {
        _state = _state.WithCreated(New());
      }
      catch (Exception e)
      {
        _state = _state.WithError(e.Message);
      }
    }

    if (_state.State is not LoadingState.Loading or LoadingState.Unfound)
    {
      return;
    }

    if (Activate)
    {
      try
      {
        _state = _state.WithCreated(Activator.CreateInstance<T>());
      }
      catch (Exception e)
      {
        _state = _state.WithError(e.Message);
      }
    }
  }

  protected override async Task OnInitializedAsync()
  {
    if (_state.State is not LoadingState.Loading or LoadingState.Unfound)
    {
      return;
    }

    if (LoadAsync is not null)
    {
      try
      {
        _state = _state.WithValue(await LoadAsync());
      }
      catch (Exception e)
      {
        _state = _state.WithError(e.Message);
      }
    }

    if (_state.State is not LoadingState.Loading or LoadingState.Unfound)
    {
      return;
    }

    if (Id is not null && typeof(T).IsAssignableTo(typeof(IIdentifiable)))
    {
      try
      {
        _state = _state.WithValue(
          await ScopedServices
            .GetRequiredService<AgnosticQueries>()
            .ReadSingleDynamic<T>(Id));
      }
      catch (Exception e)
      {
        _state = _state.WithError(e.Message);
      }
    }

    if (_state.State is not LoadingState.Loading or LoadingState.Unfound)
    {
      return;
    }

    if (NewAsync is not null)
    {
      try
      {
        _state = _state.WithCreated(await NewAsync());
      }
      catch (Exception e)
      {
        _state = _state.WithError(e.Message);
      }
    }

    if (_state.State is not LoadingState.Loading or LoadingState.Unfound)
    {
      return;
    }

    if (ActivateAsync)
    {
      try
      {
        _state = _state.WithCreated(Activator.CreateInstance<T>());
      }
      catch (Exception e)
      {
        _state = _state.WithError(e.Message);
      }
    }
  }

}
