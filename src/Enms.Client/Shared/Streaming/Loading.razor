@using Enms.Client.State
@using MudBlazor
@using System.Text.Json

@namespace Enms.Client.Shared.Streaming

@typeparam T

@if (_state is null)
{
  return;
}

@if (_state.IsLoading)
{
  if (Progress is not null)
  {
    @Progress
    return;
  }

  <MudProgressCircular/>
  return;
}

@if (_state.Error is not null)
{
  if (Error is not null)
  {
    @Error(_state.Error!)
    return;
  }

  <MudAlert Severity="Severity.Error">
    @_state.Error
  </MudAlert>
  return;
}

@if (_state.Value is null)
{
  if (NotFound is not null)
  {
    @NotFound(_new)
    return;
  }

  <NotFound/>
  return;
}

@if (Found is not null)
{
  @Found(_state.Value)
}

<MudText>
  @JsonSerializer.Serialize(_state.Value, JsonSerializerOptions)
</MudText>

@code {
  [Parameter]
  public T? Value { get; set; }

  [Parameter]
  public Func<T?>? Load { get; set; }

  [Parameter]
  public Func<Task<T?>>? LoadAsync { get; set; }

  [Parameter]
  public Func<T?>? New { get; set; }

  [Parameter]
  public Func<Task<T?>>? NewAsync { get; set; }

  [Parameter]
  public RenderFragment? Progress { get; set; }

  [Parameter]
  public RenderFragment<string>? Error { get; set; }

  [Parameter]
  public RenderFragment<T?>? NotFound { get; set; }

  [Parameter]
  public RenderFragment<T>? Found { get; set; }

  private LoadingState<T> _state { get; set; } = new();

  private T? _new { get; set; }

  private static readonly JsonSerializerOptions JsonSerializerOptions =
    new()
    {
      WriteIndented = true
    };

  protected override void OnParametersSet()
  {
    if (Value is not null)
    {
      _state = _state.WithValue(Value);
    }
  }

  protected override void OnInitialized()
  {
    if (_state is null)
    {
      return;
    }

    if (!_state.IsLoading)
    {
      return;
    }

    if (Load is not null)
    {
      try
      {
        _state = _state.WithValue(Load());
      }
      catch (Exception e)
      {
        _state = _state.WithError(e.Message);
      }
    }

    if (_state.Value is null && New is not null)
    {
      try
      {
        _new = New();
      }
      catch (Exception e)
      {
        _state = _state.WithError(e.Message);
      }
    }
  }

  protected override async Task OnInitializedAsync()
  {
    if (_state is null)
    {
      return;
    }

    if (!_state.IsLoading)
    {
      return;
    }

    if (LoadAsync is not null)
    {
      try
      {
        _state = _state.WithValue(await LoadAsync());
      }
      catch (Exception e)
      {
        _state = _state.WithError(e.Message);
      }
    }

    if (_state.Value is null && NewAsync is not null)
    {
      try
      {
        _new = await NewAsync();
      }
      catch (Exception e)
      {
        _state = _state.WithError(e.Message);
      }
    }
  }
}
