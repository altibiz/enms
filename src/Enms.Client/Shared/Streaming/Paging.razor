@using Enms.Business.Models.Abstractions
@using Enms.Business.Queries
@using Enms.Business.Queries.Abstractions
@using Enms.Client.Base
@using Microsoft.Extensions.DependencyInjection
@using MudBlazor
@using System.Text.Json

@namespace Enms.Client.Shared.Streaming

@typeparam T

@inherits EnmsOwningComponentBase

<Loading
  T="PaginatedList<T>"
  Load="@(Page is null ? null : () => Page(_pageNumber))"
  LoadAsync="@(PageAsync is null ? null : () => PageAsync(_pageNumber))"
  Progress="@Progress"
  Error="@Error">
  <Found Context="page">
    @if (page.Items.Count == 0)
    {
      if (Empty is not null)
      {
        @Empty
      }
      else
      {
        <Empty/>
      }
    }
    else
    {
      if (Found is not null)
      {
        foreach (var item in page.Items)
        {
          @Found(item)
        }
      }
      else
      {
        foreach (var item in page.Items)
        {
          <MudText>
            @JsonSerializer.Serialize(item, JsonSerializerOptions)
          </MudText>
        }
      }

      <MudPagination
        class="mt-4"
        @bind-Selected="_pageNumber"
        PageSize="PageSize"
        TotalItems="page.TotalCount"/>
    }
  </Found>
</Loading>

@code {
  [Parameter]
  public Func<int, PaginatedList<T>>? Page { get; set; }

  [Parameter]
  public Func<int, Task<PaginatedList<T>>>? PageAsync { get; set; }

  [Parameter]
  public RenderFragment? Progress { get; set; }

  [Parameter]
  public RenderFragment<T>? Found { get; set; }

  [Parameter]
  public RenderFragment? Empty { get; set; }

  [Parameter]
  public RenderFragment<string>? Error { get; set; }

  [Parameter]
  public int PageSize { get; set; } = QueryConstants.DefaultPageCount;

  private int _pageNumber = 1;

  private static readonly JsonSerializerOptions JsonSerializerOptions =
    new()
    {
      WriteIndented = true
    };
}
